#!/bin/sh

set -e

fancy_echo() {
  printf "\n$1\n"
}

append_to_zshrc() {
  local text="$1"
  local zshrc="$HOME/.zshrc"

  if ! grep -Fqs "$text" "$zshrc"; then
    printf "\n%s\n" "$text" >> "$zshrc"
  fi
}

mkdir -p "$HOME/.bin"
touch "$HOME/.zshrc"

append_to_zshrc 'export PATH="$HOME/.bin:$PATH"'

arch="$(uname -m)"
if [ "$arch" = "arm64" ]; then
  HOMEBREW_PREFIX="/opt/homebrew"
else
  HOMEBREW_PREFIX="/usr/local"
fi

fancy_echo "Installing Homebrew ..."
/bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
append_to_zshrc "eval \"\$($HOMEBREW_PREFIX/bin/brew shellenv)\""
export PATH="$HOMEBREW_PREFIX/bin:$PATH"

fancy_echo "Installing packages with Homebrew ..."
brew update --force

brew bundle --file=- <<EOF
tap "homebrew/services"

# Core tools
brew "git"
brew "universal-ctags"
brew "ripgrep"
brew "tmux"
brew "vim"
brew "watchman"
brew "zsh"

# OpenSSL + certs (CRITICAL)
brew "openssl@3"
brew "ca-certificates"

# Dev dependencies
brew "libyaml"
brew "coreutils"
brew "yarn"

# CLI tools
brew "gh"
brew "bat"
brew "fd"
brew "starship"
brew "heroku"

# Databases
brew "redis"
cask "postgres-unofficial"

# Apps
cask "visual-studio-code"
cask "arc"
cask "github"
cask "google-chrome"
cask "1password"
cask "slack"
cask "gpg-suite-no-mail"
EOF

fancy_echo "Configuring SSL certificates (global Ruby fix) ..."

append_to_zshrc 'export SSL_CERT_FILE="/opt/homebrew/etc/ca-certificates/cert.pem"'
append_to_zshrc 'export SSL_CERT_DIR="/opt/homebrew/etc/ca-certificates"'

export SSL_CERT_FILE="/opt/homebrew/etc/ca-certificates/cert.pem"
export SSL_CERT_DIR="/opt/homebrew/etc/ca-certificates"
export RUBY_CONFIGURE_OPTS="--with-openssl-dir=$(brew --prefix openssl@3)"

fancy_echo "Installing ASDF ..."
brew install asdf
append_to_zshrc "source $(brew --prefix asdf)/libexec/asdf.sh"
. "$(brew --prefix asdf)/libexec/asdf.sh"

fancy_echo "Installing ASDF plugins ..."
asdf plugin-add ruby https://github.com/asdf-vm/asdf-ruby.git || true
asdf plugin-add nodejs https://github.com/asdf-vm/asdf-nodejs.git || true

fancy_echo "Installing latest Ruby via ASDF ..."
RUBY_VERSION="$(asdf list-all ruby | grep -v "[a-z]" | tail -1)"
asdf install ruby "$RUBY_VERSION"
asdf global ruby "$RUBY_VERSION"

gem update --system

number_of_cores=$(sysctl -n hw.ncpu)
bundle config --global jobs $((number_of_cores - 1))

fancy_echo "Installing latest Node.js via ASDF ..."
NODE_VERSION="$(asdf list-all nodejs | grep -v "[a-z]" | tail -1)"
asdf install nodejs "$NODE_VERSION"
asdf global nodejs "$NODE_VERSION"

fancy_echo "Generating SSH key ..."
ssh-keygen -t ed25519 -C "$USER@$(hostname)" -f "$HOME/.ssh/id_ed25519" -N "" || true

fancy_echo "Creating projects folder ..."
mkdir -p "$HOME/projects"

fancy_echo "Laptop setup complete âœ…"